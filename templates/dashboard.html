<!-- templates/dashboard.html -->
{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h2>Welcome, {{ current_user.company_name }}</h2>
<div class="row">
    <div class="col-md-6">
        <h3>Carbon Footprint Over Time</h3>
        <canvas id="lineChart"></canvas>
    </div>
    <div class="col-md-6">
        <h3>Breakdown by Source per Month</h3>
        <canvas id="barChart"></canvas>
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-6">
        <h3>Source Contributions</h3>
        <canvas id="pieChart"></canvas>
    </div>
    <div class="col-md-6">
        <h3>Trend Analysis</h3>
        <p>Change from previous month: {{ chart_data.trend_pct }}%</p>
        <h3>Emission Intensity Score</h3>
        <div class="alert alert-info" role="alert">
            <strong>{{ chart_data.score }}/100</strong>
        </div>
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-12">
        <h3>Previous Bills</h3>
        <div class="accordion" id="previousBillsAccordion">
            {% for bill in previous_bills %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ bill.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ bill.id }}" aria-expanded="false" aria-controls="collapse{{ bill.id }}">
                        Bill #{{ bill.bill_number or 'N/A' }} - Date: {{ bill.bill_date or 'N/A' }} - Total Emission: {{ bill.total_emission_kgco2e }} kg CO2e
                    </button>
                </h2>
                <div id="collapse{{ bill.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ bill.id }}" data-bs-parent="#previousBillsAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            <div class="col-md-4">
                                <img src="{{ url_for('uploaded_file', filename=bill.bill_file_path.split('/')[-1]) if bill.bill_file_path else '' }}" alt="Bill Image" class="img-fluid" style="max-height: 300px;">
                            </div>
                            <div class="col-md-8">
                                <ul>
                                    <li><strong>Bill Date:</strong> {{ bill.bill_date or 'N/A' }}</li>
                                    <li><strong>Bill Number:</strong> {{ bill.bill_number or 'N/A' }}</li>
                                    <li><strong>Electricity:</strong> {{ bill.electricity_usage_value or 'N/A' }} {{ bill.electricity_usage_unit or '' }}</li>
                                    <li><strong>Water:</strong> {{ bill.water_usage_value or 'N/A' }} {{ bill.water_usage_unit or '' }}</li>
                                    <li><strong>Methane:</strong> {{ bill.methane_usage_value or 'N/A' }} {{ bill.methane_usage_unit or '' }}</li>
                                    <li><strong>Oil:</strong> {{ bill.oil_usage_value or 'N/A' }} {{ bill.oil_usage_unit or '' }}</li>
                                    <li><strong>Coal:</strong> {{ bill.coal_usage_value or 'N/A' }} {{ bill.coal_usage_unit or '' }}</li>
                                    <li><strong>Industrial Waste:</strong> {{ bill.industrial_waste_value or 'N/A' }} {{ bill.industrial_waste_unit or '' }}</li>
                                    <li><strong>Trade CO2:</strong> {{ bill.trade_co2_value or 'N/A' }} tons</li>
                                    <li><strong>Natural Gas:</strong> {{ bill.natural_gas_usage_value or 'N/A' }} {{ bill.natural_gas_usage_unit or '' }}</li>
                                    <li><strong>Petrol:</strong> {{ bill.petrol_usage_value or 'N/A' }} {{ bill.petrol_usage_unit or '' }}</li>
                                    <li><strong>Diesel:</strong> {{ bill.diesel_usage_value or 'N/A' }} {{ bill.diesel_usage_unit or '' }}</li>
                                    <li><strong>Billing Period Start:</strong> {{ bill.billing_period_start or 'N/A' }}</li>
                                    <li><strong>Billing Period End:</strong> {{ bill.billing_period_end or 'N/A' }}</li>
                                    <li><strong>Total CO2 Tonnes:</strong> {{ bill.total_co2_tonnes }}</li>
                                    <li><strong>Total Emission kg CO2e:</strong> {{ bill.total_emission_kgco2e }}</li>
                                    <li><strong>Uploaded At:</strong> {{ bill.uploaded_at }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    const ctxLine = document.getElementById('lineChart').getContext('2d');
    new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: {{ chart_data.line.labels | tojson }},
            datasets: [{
                label: 'CO2e Emissions (kg)',
                data: {{ chart_data.line.data | tojson }},
                borderColor: 'rgba(75, 192, 192, 1)',
                tension: 0.1
            }]
        },
        options: { animations: { tension: { duration: 1000, easing: 'linear' } } }
    });

    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: {{ chart_data.bar.labels | tojson }},
            datasets: {{ chart_data.bar.datasets | tojson }}
        },
        options: {
            scales: { x: { stacked: true }, y: { stacked: true } },
            animations: { duration: 1000 }
        }
    });

    const ctxPie = document.getElementById('pieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: {{ chart_data.pie.labels | tojson }},
            datasets: [{
                data: {{ chart_data.pie.data | tojson }},
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#C9CBCF', '#ADFF2F', '#FFD700']
            }]
        },
        options: { animations: { borderWidth: { duration: 1000, easing: 'easeOutBounce' } } }
    });
</script>
{% endblock %}